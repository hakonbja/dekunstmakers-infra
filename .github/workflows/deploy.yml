name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (leave empty for latest release, or enter specific tag like v1.0.0)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get latest release tag
        id: get_tag
        if: github.event.inputs.release_tag == ''
        run: |
          TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq .tag_name)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set deployment tag
        id: set_tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ steps.get_tag.outputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.set_tag.outputs.tag }}

      - name: Deploy infrastructure files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "/root/dekunstmakers/"
          strip_components: 0

      - name: Apply infrastructure changes
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /root/dekunstmakers
            docker-compose pull
            docker-compose up -d
            docker-compose ps
